---
title: "2020 데이터사이언스 입문<br>"
subtitle: "서울시 수소차 확산에 관한 예측 <br><br>"
author: "팀 RHINO"
date: "2020년 6월 22월"
output:
  xaringan::moon_reader:
    lib_dir: libs
    nature:
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false

---
background-image: url("https://i.pinimg.com/originals/4e/73/d4/4e73d4c90394a0040767af0fda11f0d6.jpg")
class: center, middle, inverse



```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)

knitr::opts_chunk$set(echo = FALSE, warning=FALSE, message=FALSE, 
                      comment="", digits = 3, tidy = FALSE, prompt = TRUE, fig.align = 'center')


```


# 팀 RHINO
### 아프리카 초원의 코뿔소는 <br> 약간의 물만 마시고도 자동차만한 몸을 달린다. 

이현탁, 이재상, 손지우, 서경덕, 정권상

---

## 0. 개요
## 1. 주제 선정 배경
## 2. 데이터 추출 및 전처리
## 3. EDA 및 모델링
## 4. 시각화 및 대쉬보드
## 5. 최종 결과


---
class: inverse, middle, center

# 1. 주제 선정 배경

---
## 수소전기차 전쟁 발발


<img src="https://github.com/statkwon/rhino/blob/master/fig/%EA%B7%B8%EB%A6%BC2.png?raw=true" alt= "기사" />

---
## 국내 현황
.pull-left[
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EA%B7%B8%EB%A6%BC3.png?raw=true" alt= "국내 계획" />
]

.pull-right[
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EA%B7%B8%EB%A6%BC9.png?raw=true" alt= "서울시 충전소 계획" />
]

---

class: center


## 수소차 / 충전소
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EA%B7%B8%EB%A6%BC5.png?raw=true" alt= "닭계란" />

---

## 모델링

1. 충전소 입지 선정에 필요한 변수

2. 수소차 확산dㅔ 중요한 변수

---
## 시뮬레이션 

충전소 위치가 수소차에 주는 영향을 이용 

서울시에서 어디에 충전소가 생기면 수소차가 더 많이 늘어날까?

---
## 대쉬보드

<img src="https://github.com/statkwon/rhino/blob/master/fig/%EA%B7%B8%EB%A6%BC16.png?raw=true" alt= "대쉬보드" />

---

## 블로그

<img src="https://github.com/statkwon/rhino/blob/master/fig/%EA%B7%B8%EB%A6%BC14.png?raw=true" alt= "블로그" />

---


class: inverse, middle, center

# 2. 데이터 추출 및 전처리

---

class: inverse, middle, center

# 3. EDA 및 모델링
```{r include = FALSE}
library(ggplot2)
library(tidyverse)
gas_tbl <- read.csv("https://raw.githubusercontent.com/statkwon/rhino/master/data/cleansing/gasstation_imputation.csv")

```
---
## EDA - 교통량
```{r 교통량, fig.height = 7, fig.width = 11}
gas_tbl %>%
  mutate(flow = (inflow+outflow)/2) %>% 
  select(gu, flow) %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(x = gu, y =flow), stat= "identity")+
  coord_flip()+
  theme(legend.position = "none")+
  xlab("자치구")

```

---
## EDA - 기업 / 유통업체
```{r 기업/유통업체 , fig.height = 7, fig.width = 11}
gas_tbl %>% 
  select(gu, enterprise, distributor) %>% 
  gather(key = "key", value = "n", enterprise:distributor) %>%
  ggplot(aes(y= gu, fill = key))+
  geom_bar(aes(x = n), stat = "identity")+
  ylab("자치구")+
  xlab("enterprise & distributor")

```
---
## EDA - 공시지가
```{r 공시지가 , fig.height = 7, fig.width = 11}
gas_tbl %>%
  ggplot(aes(fill = gu))+
  geom_bar(aes(y =  gu, x =land_value), stat= "identity")+
  coord_fixed(xlim=c(100,125))+
  theme(legend.position = "none")+
  ylab("자치구")
```

---
## EDA - 인구 관련
```{r 인구관련, fig.height = 8, fig.width= 12}
parking_area_plot<-
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= parking_area), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")+
  scale_y_discrete(breaks = c())


road_area_plot<-
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= road_area), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")+
  scale_y_discrete(breaks =c())

pop_plot<-
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= population), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")+
  scale_y_discrete(breaks =c())

day_pop_plot <-
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= day_pop), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")+
  scale_y_discrete(breaks =c())

night_pop_plot<-
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= night_pop), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")+
  scale_y_discrete(breaks =c())

legend<-
gas_tbl %>% 
  ggplot(aes(fill =gu))+
  geom_bar(aes(x= gu, y =c(0)), stat = "identity")+
  scale_fill_discrete(name = "자치구")+
  theme(legend.position = "top")
  
library(gridExtra)
grid.arrange(parking_area_plot, road_area_plot,pop_plot, day_pop_plot,night_pop_plot, nrow= 2)

```

---
## EDA - 학교
```{r 학교 , fig.height = 7, fig.width = 11}
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= school), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")
```
---

## EDA - 대학교
```{r 대학교 , fig.height = 7, fig.width = 11}
gas_tbl %>% 
  ggplot(aes(fill = gu))+
  geom_bar(aes(y=gu, x= university), stat = "identity")+
  theme(legend.position = "none")+
  ylab("자치구")
```

---
## EDA - 주유소 / 차량 대수
```{r 타겟플랏 , fig.height = 7, fig.width = 11}
gas_tbl %>%
  ggplot(aes(fill = gu))+
  geom_bar(aes(y =  gu, x =car_per_station), stat= "identity")+
  theme(legend.position = "none")+
  ylab("자치구")

```
---
## EDA - 상관계수
```{r 상관계수 , fig.height = 7, fig.width = 11}
gas_corr <- cor(gas_tbl[,5:16])
corrplot::corrplot(gas_corr)
```
---
## EDA - 교통량 변수 상관성
```{r 교통량 상관계수 , fig.height = 7, fig.width = 11}
gas_tbl %>% 
  ggplot(aes(x= inflow, y= outflow))+
  geom_point()
```

---
class: center
## 모델링

.pull-left[
###[충전소 주인입장]

- 특정 구에 충전소를 설치해도 되는가?
1. 주유소 설치와 관련 잇는 변수 찾기
2. 수소충전소와 수소차 수 상관관계
]

.pull-right[
###[수소차 주인입장]

- 특정 구에 충전소가 설치된다면,<br> 수소차를 얼마나 더 살 것인가?

]

<br> <br>
## **=> 3. 최종 예측 모델 선정**

---
## 모델링 - part 1
> 주유소 설치와 관련 있는 변수 찾기

.pull-left[
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EB%AA%A8%EB%8D%B8%EB%A7%81%20%EC%8B%9C%EB%8F%84.png?raw=truee" alt= "모델링 시도" />
]

.pull-right[
다양한 분석기법 활용
- Decision Tree
- Bagging
- Random Forest

타겟변수의 관찰치 표준화<br>
: 주유소 개수 당 자동차 대수
]

---
## 모델링 - part 1
> 주유소 설치와 관련 있는 변수 찾기

.pull-left[

1) Decision Tree

- inflow
- outflow
- enterprise
- day_pop
- distributor

]

.pull-right[
**PLOT**
]
---
## 모델링 - part 1
> 주유소 설치와 관련 있는 변수 찾기

.pull-left[

2) Bagging

- enterprise
- inflow
- land_value
- outflow
- university


]

.pull-right[
**PLOT**
]
---
## 모델링 - part 1
> 주유소 설치와 관련 있는 변수 찾기

.pull-left[

3) Random Forest

- inflow
- enterprise
- outflow
- university
- distributor

]

.pull-right[
**PLOT**
]
---
## 모델링 - part 1
> 주유소 설치와 관련 있는 변수 찾기

.center[
<br>
### <최종선택 중요변수>
### outflow<br>
### land_value<br>
### enterprise<br>
### distributor


]

---
## 모델링 - part 2
> 수소충전소와 수소차 수 상관관계

.center[
### 가까운 거리에 수소충전소가 있으면<br> 수소차를 더 많이 살까?

**CODE**

### 그렇다  => 이 중에서는 r1, r2 두 개만 쓰도록 하자!

]
---
## 모델링 - part 3
> 최종 예측 모델 선정 

.pull-left[

Decision Tree

**CODE**

Train-Test Split 하지 않은 과적합모형인데도
MSE 높다


]

.pull-right[
Linear Regression


**CODE**

]

---
## 모델링 - part 3
> 최종 예측 모델 선정 <br> Linear Regression Model 성능 확인

**CODE**

---
## 시뮬레이션
> OO구 OO동에 수소충전소를 설치한다면 수소차는 얼마나 늘어날까?

.pull-left[
1) 새로운 충전소가 추가되었을 때,<br>
가까운 충전소 거리 업데이트

r1 & r2 update

r1: 가장 가까운 수소충전소까지의 거리
r2: 두번째로 가까운 수소충전소까지의 거리

]

.pull-right[
2) 각 행정동 별로 수소차 변동 예측

CV를 이용한 glm 모델 사용

]
---
## 시뮬레이션
> OO구 OO동에 수소충전소를 설치한다면 수소차는 얼마나 늘어날까?

**CODE**

- 가장 가까운 수소충전소까지의 거리가 줄어들수록, 수소차 수 증가
- 교통량이 많을수록, 수소차 수 증가
- 사업체 수가 많을수록, 수소차 수 증가


---
## 시뮬레이션
> OO구 OO동에 수소충전소를 설치한다면 수소차는 얼마나 늘어날까?

.pull-left[
예시 1) 강동구 강일동에 설치된다면?

Before: 원래 차량수
Before_pred: 차량수 예측(현재 기준)
After_pred: 차량수 예측(새로운 충전소 가정)

]

.pull-right[
**CODE**

]
---
## 시뮬레이션
> OO구 OO동에 수소충전소를 설치한다면 수소차는 얼마나 늘어날까?

.pull-left[
Top 1: 강북구 미아동 설치시, 69대 증가

**Dash board**

]

.pull-right[
Top 5
**CODE**

]
---


class: inverse, middle, center

# 4. 시각화 및 대쉬보드

---
## 시각화 - Layout 기획

- Tab 1. 구별 특성 그래프
 - Infobox로 최대값/중위값/최소값을 나타내는 구를 표시
 - ggplotly로 구 간의 특성을 한눈에 비교

- Tab 2. 구별 특성 테이블
 - Tab 1.을 만드는데 사용한 데이터테이블을 interactive하게 표현.

- Tab 3. 구별 특성 지도
 - Leaflet으로 구 간의 특성을 한눈에 비교(값에 따라 색상 변화)

- Tab 4. 수소차 충전소 지도
 - 동별로 수소차 충전소를 설치하였을 때의 수소차수의 예측 증가량을 지도와 테이블로 표현.

---

## 시각화 - 구현방법
> R : shinydashboard, leaflet 이용

### 1) Leaflet으로 서울시내 구별 경계구분도 그리기

행정구역도 데이터(shp파일)를 다운하여 좌표계 leaflet의 polygon기능이용. SHP파일은 GRS80좌표계 기준이라 Leaflet기준 WGS84 좌표계로 변환하였다.

[참고 블로그](https://statkwon.netlify.app/2020/06/15/leaflet을-이용한-서울시-interactive-map-제작/)

### 2) Shinydashboard 이용 
코드트레이닝 – 데이터캠프 및 구글 이용

수차례의 팀회의를 통하여 레이아웃 결정 및 코드 오류 해결 

---

## 시각화 - Issue

- 1) 사이즈변환문제(각 pc환경에 따라 plot사이즈가 다르게 나옴)
 <br><br>=> css를 이용한 상대적 사이즈 이용 및 plotly이용

- 2) shinydashboard에서 여러 개의 tab에 select input이 들어가는 경우 오류 발생
 <br><br>=> dashboard자체 문제, selectinput 타입 조정

- 3) 다중 selectinput을 탭에 삽입하는 문제
<br><br>=> 각 input을 서버에서 처리해서 해결. 하지만 로딩시간이 발생, 로딩동안 지도와 테이블에 input이 선택되지 않았다고 뜸. 

- 4) selectinput 클릭 시에 테이블과 지도를 변경하는 문제
<br><br>=> reactive function으로 여러 번 코드를 다시 짜면서 해결

---
class: inverse, middle, center

# 5. 최종 결과

---
## 수소차 증가량이 가장 많은 충전소 입지 Top 5

**Image**

---
## 수소차 충전소 위치(2020년 6월 기준)
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EC%88%98%EC%86%8C%EC%B0%A8%20%EC%B6%A9%EC%A0%84%EC%86%8C.png?raw=true
---" alt= "충전소 위치" />


---
## 프로젝트를 진행하며 아쉬웠던 점

.pull-left[

- 등록된 수소차 수 부족으로 인한 모델링의 어려움
]

.pull-right[
- 동별 데이터 부족으로 충전소와의 거리 변수를 제외하고는 구별 데이터 위주의 사용
]

---
## 최종 전망

.pull-left[
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EC%88%98%EC%86%8C%EC%B0%A8%20%EA%B8%B0%EB%B0%98%20%EC%8B%9C%EC%84%A4.png?raw=true" alt= "수소차 기반 시설" width = "250"/>
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EC%88%98%EC%86%8C%EC%B0%A8%20%EA%B4%80%EB%A0%A8%EC%A3%BC.png?raw=true" alt= "수소차 관련주" width = "300"/>

]

.pull-right[
<img src="https://github.com/statkwon/rhino/blob/master/fig/%EC%88%98%EC%86%8C%EC%B0%A8%20%ED%9D%A5%ED%96%89.png?raw=true" alt= "수소차 흥행" />
]

---






